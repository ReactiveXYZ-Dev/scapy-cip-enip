#!/usr/bin/env python2
import binascii
from scapy.all import *
import cip

# rawpkt = binascii.unhexlify(
#     '001D9CEE5EF4000C29C092CF08004500'
#     '00581CBB400040060B1BC0A8C888C0A8'
#     'C8F0C917AF128AC4A4C30F9DABF85018'
#     '7210131500006F001800362D00000000'
#     '00003000000000000000000000000000'
#     '00000000020000000000B20008000E03'
#     '200F24023001')
# pkt = Ether(rawpkt)
#pkt.show()
#print(pkt[cip.CIP].path)


def test_hex_packet(hex_packet):
    rawpkt=binascii.unhexlify(hex_packet)
    pkt = Ether(rawpkt)
    # pkt = cip.CIP_PathPadded(rawpkt)

    pkt.show()
    print "=" * 60
    print ""
    return rawpkt

# List Identity = Good
# rawpkt = test_hex_packet("000c29c092cf0000bc5e5264080045000067787600004011ef42c0a8c8f3c0a8c888af12ce9500533bbe63003300000000000000000000000000000000000000000001000c002d0001000002af12c0a8c8f3000000000000000001000c003a0004086000e5e166000b313735362d454e42542f4103")
# rawpkt = test_hex_packet("000c29c092cf0000bc5e5264080045000067787600004011ef42c0a8c8f3c0a8c888af12ce9500533bbe63003300000000000000000000000000000000000000000001000c002d0001000002af12c0a8c8f3aabbccddeeffaabb01000c003a0004086000e5e166000b313735362d454e42542f4103")

# Register Session: Already Implemented = Works
# rawpkt = test_hex_packet("0000bcc631b1001d9ce985800800450000441dcf000040064a0dc0a8c891c0a8c8f5af120be382a044a77c5ec1a7501810005f94000065000400030000000000000000000000000000000000000001000000")

# List Services = Works
# rawpkt = test_hex_packet("0000bcc631b1e49069a52e9d08004500007e00774000400626e3c0a8c8f1c0a8c8f5af120be47c7fcc227c838750801810002e4e00000101080a000000440000004404003200000000000000000000000000000000000000000002000001140001002001436f6d6d756e69636174696f6e7300000001140001002001436f6d6d756e69636174496f6e730000")
# rawpkt = test_hex_packet("0000bcc631b1e49069a52e9d08004500007e00774000400626e3c0a8c8f1c0a8c8f5af120be47c7fcc227c838750801810002e4e00000101080a000000440000004404003200000000000000000000000000000000000000000002000001140001002001436f6d6d756e69636174696f6e730000")
# rawpkt = test_hex_packet("0000bcc631b1001d9ce9858008004500005a1dce0000400649f8c0a8c891c0a8c8f5af120be382a044757c5ec18b50181000afc4000004001a00000000000000000000000000000000000000000001000001140001002001436f6d6d756e69636174696f6e730000")

# Forward Open Success --> PLC/Computer = Works
# rawpkt = test_hex_packet("000c29c092cf0000bcc631b108004500007a9bc7400040068be7c0a8c8f5c0a8c888af12c8d5c0c306893d79a13880181000e7c100000101080a000434f10267e0e06f002e000037021400000000000000000000000000000000000000000000020000000000b2001e00d40000000215aa003000fe8037134d00efbeadde00127a0000127a000000")

# Forward Open: PLC --> PowerFlex 0.5HP _ Pkt 113 in AfterReboot pcap
rawpkt = test_hex_packet("001d9ce985800000bcc631b10800450000c8008b4000400626cdc0a8c8f5c0a8c8910be3af127c5ec1a782a044c35018100005d900006f0088000300000000000000c0a8c8f50000007400000000000000000000020000000000b2007800540220062401059b0000000000000000000001009ffe620000000000000000000004000000000004812734040100960009008103200424062c022c01801d01000000820000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000")

# Forward Open Big PowerFlex
# rawpkt = test_hex_packet("e49069a52e9d0000bcc631b10800450000ae009f400040062673c0a8c8f5c0a8c8f10be4af127c83876c7c7fcc7080181000d87600000101080a00000044000000456f0062000001020c00000000c0a8c8f50000007100000000000000000000020000000000b2005200540220062401059b00000000010eaa00030001009ffe62000000000050c30000164850c300001648811434040000000000000000200424032c012c02800a01000300000010007d0c0300000010007d0a0000")


# Forward Close --> PLC/Computer
#rawpkt = test_hex_packet("0000bcc631b1000c29c092cf080045000074402540004006e78fc0a8c888c0a8c8f5c8d5af123d79a17cc0c30701801800e5133600000101080a0267e0e6000434f16f0028000037021400000000000000000000000000000000000000000000020000000000b20018004e022006240100f937134d00efbeadde0300010020022401")

# Forward Open: Computer --> PLC
# rawpkt = test_hex_packet("0000bcc631b1000c29c092cf08004500008c402340004006e779c0a8c888c0a8c8f5c8d5af123d79a0e0c0c30689801800e5134e00000101080a0267e0e0000434f16f0040000037021400000000000000000000000000000000000000000000020000000000b200300054022006240100f9310000803000fe8037134d00efbeadde0000000000127a00f44100127a00f441a303010020022401")



#ListIdentity(pkt)
#ListServices(pkt)